name: CI

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version-file: '.node-version'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install
      - name: Build
        run: pnpm build

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version-file: '.node-version'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install
      - name: Lint
        run: pnpm lint

  check-statistics:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Check statistics length
        run: |
          # Get package.json from master branch
          git show origin/master:package.json > master-package.json

          # Compare statistics length
          echo "üìä Statistics comparison:"
          echo ""

          # Show total length
          master_total=$(jq -r '.statistics.length' master-package.json)
          current_total=$(jq -r '.statistics.length' package.json)
          echo "Total: $master_total ‚Üí $current_total"
          echo ""

          # Compare each service's length
          service_count=$(jq -r '.statistics.services | length' package.json)
          has_error=0

          for i in $(seq 0 $((service_count - 1))); do
            service=$(jq -r ".statistics.services[$i].name" package.json)
            master_length=$(jq -r ".statistics.services[$i].length" master-package.json)
            current_length=$(jq -r ".statistics.services[$i].length" package.json)

            echo "$service: $master_length ‚Üí $current_length"

            if [ "$current_length" -lt "$master_length" ]; then
              echo "‚ùå Error: $service length decreased from $master_length to $current_length"
              has_error=1
            fi
          done

          if [ "$has_error" -eq 1 ]; then
            echo ""
            echo "‚ùå One or more services have decreased length"
            exit 1
          fi

          echo ""
          echo "‚úÖ All statistics checks passed"
